<nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
        <a class="navbar-brand" routerLink="/home">MusicLab</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
          <ul class="navbar-nav">
             <li class="nav-item"><a class="nav-link" routerLink="/content" routerLinkActive="active">My content</a></li>
             <li class="nav-item"><a class="nav-link" routerLink="/upload" routerLinkActive="active">Upload</a></li>
             <li class="nav-item"><a class="nav-link" routerLink="/search" routerLinkActive="active">Search</a></li>
             <li class="nav-item"><a class="nav-link" routerLink="/inbox" routerLinkActive="active">Inbox</a></li>
             <li class="nav-item dropdown">
                 <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown">Options</a>
                 <ul class="dropdown-menu">
                   <li><a class="dropdown-item" routerLink="/profile">Profile</a></li>
                   <li><a class="dropdown-item" routerLink="/settings">Settings</a></li>
                 </ul>
             </li>
             <li class="nav-item" *ngIf="userRole === 1 || userRole === 2">
                <a class="nav-link text-warning fw-bold" routerLink="/admin" routerLinkActive="active">
                  <i class="bi bi-shield-lock-fill"></i> Control Panel
                </a>
             </li>
          </ul>
        </div>
        <button (click)="logout()" class="btn btn-outline-danger">Log out</button>
    </div>
</nav>

<div class="container mt-5 pb-5">
    
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-5 p-4 rounded-4 glass-header">
        <div>
            <h1 class="display-6 fw-bold text-white mb-1">
                <i class="bi bi-speedometer2 me-2 text-info"></i> Panel de Control
            </h1>
            <p class="text-secondary mb-0" *ngIf="userRole === 1">Administrador</p>
            <p class="text-info mb-0" *ngIf="userRole === 2">Owner Access</p>
        </div>
        <button class="btn btn-lg btn-outline-light px-4" (click)="cargarUsuarios()">
            <i class="bi bi-arrow-clockwise me-2"></i> Actualizar
        </button>
    </div>

    <div *ngIf="loading" class="text-center py-5">
        <div class="spinner-border text-info" style="width: 3rem; height: 3rem;" role="status"></div>
    </div>

    <div *ngIf="!loading" class="table-card">
        <div class="table-responsive">
            <table class="custom-table">
                <thead>
                    <tr>
                        <th class="ps-4">Usuario</th>
                        <th>Rol</th>
                        <th>Estado</th>
                        <th class="text-end pe-4">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let user of usersList">
                        <td class="ps-4">
                            <div class="d-flex align-items-center">
                                <div class="avatar-wrapper">
                                    <img [src]="'http://localhost/phpMusicLab/uploads/' + user.profile_img_url" 
                                         (error)="handleImageError($event)" class="user-avatar">
                                    <span class="status-dot" [ngClass]="user.status == 1 ? 'status-active' : 'status-blocked'"></span>
                                </div>
                                <div class="ms-3">
                                    <h6 class="mb-0 fw-bold text-white">{{ user.first_name }} {{ user.last_name }}</h6>
                                    <small class="text-muted">{{ user.email }}</small>
                                </div>
                            </div>
                        </td>

                        <td>
                            <span *ngIf="user.role == 0" class="badge bg-secondary">User</span>
                            <span *ngIf="user.role == 1" class="badge bg-info text-dark">Admin</span>
                        </td>

                        <td>
                            <span *ngIf="user.status == 1" class="text-success small fw-bold"><i class="bi bi-check-circle-fill"></i> Activo</span>
                            <span *ngIf="user.status == 0" class="text-danger small fw-bold"><i class="bi bi-slash-circle-fill"></i> Bloqueado</span>
                        </td>

                        <td class="text-end pe-4">
                            <div class="action-buttons">
                                
                                <button (click)="abrirModalPosts(user)" class="btn-action-text btn-posts-action" title="Ver Publicaciones">
                                    <i class="bi bi-collection-play-fill"></i> Posts
                                </button>

                                <button (click)="abrirModalEdicion(user)" class="btn-action-text btn-edit-action" title="Editar Datos">
                                    <i class="bi bi-pencil-square"></i> Editar
                                </button>

                                <button *ngIf="user.status == 1" (click)="toggleBlockUser(user)" class="btn-action-text btn-block-action">
                                    <i class="bi bi-lock-fill"></i> Bloquear
                                </button>
                                <button *ngIf="user.status == 0" (click)="toggleBlockUser(user)" class="btn-action-text btn-unblock-action">
                                    <i class="bi bi-unlock-fill"></i> Habilitar
                                </button>

                                <button (click)="deleteUser(user)" class="btn-action-text btn-delete-action">
                                    <i class="bi bi-trash-fill"></i> Eliminar
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div *ngIf="modalEdicionAbierto" class="custom-modal-overlay">
    <div class="custom-modal-content">
        <div class="modal-header">
            <h5 class="text-white mb-0"><i class="bi bi-pencil-square me-2"></i> Editar Usuario</h5>
            <button (click)="cerrarModales()" class="btn btn-sm btn-outline-secondary"><i class="bi bi-x-lg"></i></button>
        </div>
        <div class="modal-body">
            <form (ngSubmit)="guardarCambiosUsuario()">
                
                <div class="d-flex flex-column align-items-center mb-4">
                    <div class="mb-3 rounded-circle overflow-hidden border border-2 border-secondary position-relative" 
                         style="width: 100px; height: 100px; background: #000;">
                        
                        <img [src]="previewUrl ? previewUrl : (
                                usuarioSeleccionado.profile_img_url && usuarioSeleccionado.profile_img_url !== 'default_profile.png' 
                                ? 'http://localhost/phpMusicLab/uploads/' + usuarioSeleccionado.profile_img_url 
                                : 'http://localhost/phpMusicLab/assets/default_profile.png'
                             )" 
                             style="width: 100%; height: 100%; object-fit: cover;"
                             alt="User Avatar">
                    </div>
                    
                    <label class="btn btn-sm btn-outline-info" style="cursor: pointer;">
                        <i class="bi bi-camera-fill me-2"></i> Cambiar Foto
                        <input type="file" (change)="onFileSelected($event)" accept="image/*" hidden>
                    </label>
                </div>
                <div class="row">
                    <div class="col-6">
                        <label class="form-label">Nombre</label>
                        <input type="text" [(ngModel)]="usuarioSeleccionado.first_name" name="first_name" class="custom-input" required>
                    </div>
                    <div class="col-6">
                        <label class="form-label">Apellido</label>
                        <input type="text" [(ngModel)]="usuarioSeleccionado.last_name" name="last_name" class="custom-input" required>
                    </div>
                </div>

                <label class="form-label">Email</label>
                <input type="email" [(ngModel)]="usuarioSeleccionado.email" name="email" class="custom-input" required>

                <label class="form-label">Tipo de Artista</label>
                <select [(ngModel)]="usuarioSeleccionado.artist_type" name="artist_type" class="custom-input form-select bg-dark text-white border-secondary">
                    <option value="Vocalist">Vocalist</option>
                    <option value="Guitarist">Guitarist</option>
                    <option value="Bassist">Bassist</option>
                    <option value="Drummer">Drummer</option>
                    <option value="Pianist">Pianist</option>
                    <option value="DJ">DJ</option>
                    <option value="Producer">Producer</option>
                    <option value="Another">Another</option>
                </select>

                <label class="form-label">Biografía</label>
                <textarea [(ngModel)]="usuarioSeleccionado.bio" name="bio" class="custom-input" rows="3"></textarea>

                <hr class="border-secondary my-3">
                <label class="form-label text-warning">Cambiar Contraseña <small class="text-muted">(Opcional)</small></label>
                <input type="password" [(ngModel)]="nuevaPassword" name="password" class="custom-input" placeholder="Nueva contraseña...">

                <div class="d-flex justify-content-end mt-4 gap-2">
                    <button type="button" (click)="cerrarModales()" class="btn btn-outline-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-primary px-4">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div *ngIf="modalPostsAbierto" class="custom-modal-overlay">
    <div class="custom-modal-content">
        <div class="modal-header">
            <h5 class="text-white mb-0">
                <i class="bi bi-collection-play-fill me-2"></i> Posts de {{ usuarioSeleccionado.first_name }}
            </h5>
            <button (click)="cerrarModales()" class="btn btn-sm btn-outline-secondary"><i class="bi bi-x-lg"></i></button>
        </div>
        <div class="modal-body p-0">
            
            <div *ngIf="cargandoPosts" class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
            </div>

            <div *ngIf="!cargandoPosts && listaPostsUsuario.length === 0" class="text-center py-5 text-muted">
                <i class="bi bi-music-note-beamed fs-1"></i>
                <p class="mt-2">Sin publicaciones.</p>
            </div>

            <ul *ngIf="!cargandoPosts && listaPostsUsuario.length > 0" class="list-group list-group-flush">
                <li *ngFor="let post of listaPostsUsuario" class="list-group-item bg-transparent text-white border-secondary d-flex justify-content-between align-items-center p-3">
                    <div class="d-flex align-items-center overflow-hidden">
                        <i class="bi bi-file-music text-info fs-4 me-3"></i>
                        <div>
                            <div class="fw-bold">{{ post.title }}</div>
                            <small class="text-muted">{{ post.created_at | date:'shortDate' }}</small>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <a [href]="'http://localhost/phpMusicLab/uploads/' + post.file_url" target="_blank" class="btn btn-sm btn-outline-light">
                            <i class="bi bi-play-fill"></i>
                        </a>
                        <button (click)="eliminarPost(post)" class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </li>
            </ul>
        </div>
        <div class="p-3 bg-dark text-end border-top border-secondary">
            <button (click)="cerrarModales()" class="btn btn-secondary btn-sm">Cerrar</button>
        </div>
    </div>
</div>